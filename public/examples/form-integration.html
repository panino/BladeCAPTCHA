<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Formulario protegido con CAPTCHA</title>
		<link rel="stylesheet" href="../css/captcha.css">
		<style>
			:root {
				--header-height: 60px;
				font-size: 14px;
			}

			html {
				scroll-padding-top: var(--header-height);
			}

			.sticky-header {
				align-items: center;
				background-color: #1e1e1e;
				border-bottom: 1px solid #444;
				color: #f5f5f5;
				display: flex;
				height: var(--header-height);
				padding: 0 1rem;
				position: sticky;
				top: 0;
				z-index: 1000;
			}

			.sticky-header nav {
				align-items: center;
				display: flex;
				justify-content: space-between;
				margin: 0 auto;
				max-width: 1024px;
				width: 100%;
			}

			.sticky-header .logo {
				color: inherit;
				font-size: 1.2rem;
				font-weight: 700;
				text-decoration: none;
			}

			.sticky-header .nav-links {
				display: flex;
				gap: 1rem;
				list-style: none;
				margin: 0;
				padding: 0;
			}

			.sticky-header .nav-links a {
				color: inherit;
				font-weight: 500;
				text-decoration: none;
			}

			.sticky-header .nav-links a:focus,
			.sticky-header .nav-links a:hover {
				text-decoration: underline;
			}

			.menu-toggle {
				background: none;
				border: none;
				color: inherit;
				cursor: pointer;
				display: none;
				font-size: 1.5rem;
			}

			body {
				margin: 0 auto;
				padding: 0 !important;
				width: 100%;
				font-family: Verdana, Geneva, sans-serif;
			}

			main {
				margin: auto;
				margin-top: var(--header-height);
				max-width: 600px;
				padding: 0 2rem 20px;
			}

			footer {
				background: #fff;
				bottom: 0;
				color: #999;
				font-size: .9rem;
				left: 0;
				margin-top: 4rem;
				position: fixed;
				text-align: center;
				width: 100%;
			}

			@media (max-width:600px) {
				.menu-toggle {
					display: block;
				}

				.sticky-header .nav-links {
					background-color: #1e1e1e;
					border-top: 1px solid #444;
					bottom: 0;
					display: none;
					flex-direction: column;
					left: 0;
					overflow-y: auto;
					padding: 1rem;
					position: fixed;
					right: 0;
					top: var(--header-height);
					z-index: 1001;
				}

				.sticky-header .nav-links.show {
					display: flex;
				}
			}

		</style>
	</head>
	<body>
		<header class="sticky-header">
			<nav>
				<a href="https://disegnocentell.com.ar/BladeCAPTCHA/" class="logo" aria-label="BladeCAPTCHA home"><span class="emoji">🐢</span> BladeCAPTCHA</a>
				<button class="menu-toggle" aria-label="Abrir menú"><span class="emoji">☰</span></button>
				<ul class="nav-links">
					<li>
						<a href="https://disegnocentell.com.ar/BladeCAPTCHA/">Inicio</a>
					</li>
					<li>
						<a href="https://disegnocentell.com.ar/BladeCAPTCHA/documentacion.html">Documentación</a>
					</li>
					<li>
						<a href="https://github.com/panino/BladeCAPTCHA" target="_blank" rel="noopener noreferrer">GitHub</a>
					</li>
					<li>
						<a href="https://disegnocentell.com.ar/BladeCAPTCHA/en/" lang="en" hreflang="en">English</a>
					</li>
				</ul>
			</nav>
		</header>
		<main>
			<h1>Formulario protegido con CAPTCHA</h1>
			<p id="captchaInstructions">Completa el formulario y presiona el botón 'Enviar'</p>

			<form id="formulario" method="post" action="../php/procesar-formulario.php">
				<label>
					<input type="text" name="nombre" placeholder="Escribe tu nombre">
				</label>
				<button id="submitBtn" type="submit">Enviar</button>
				<progress id="progreso" value="0" max="100" aria-label="Progreso de resolución del CAPTCHA">0%</progress>
				<div id="status" role="status" aria-live="polite"></div>
			</form>

			<script type="module">
				import {initCaptcha} from '../js/captcha.js';
				(async () => {
					let memo = null; // Variable compartida para onStart y onEnd
					try {
						await initCaptcha({
							mode: 'autoFormIntegration',
							apiBaseUrl: '../php',
							formSelector: '#formulario',
							inputName: 'captcha_token',
							statusSelector: '#status',
							submitButtonSelector: '#submitBtn',
							onStart: () => {
								let submitButton = document.querySelector('#submitBtn');
								memo = submitButton.textContent;
								submitButton.disabled = true;
								submitButton.style.cursor = 'wait';
								submitButton.textContent = 'Por favor espere...';
								console.log("Procesando...");

							},
							onEnd: () => {
								let submitButton = document.querySelector('#submitBtn');
								submitButton.textContent = memo;
								submitButton.disabled = false;
								submitButton.style.cursor = 'pointer';
								console.log("Proceso terminado");
							},
							onProgress: (p) => {
								let prog = document.querySelector('#progreso');
								prog.style.visibility = p ? 'visible' : 'hidden';
								prog.value = p;
								if (p === 100) setTimeout(() => prog.style.visibility = 'hidden', 100);
							}
						});
					} catch (err) {
						console.error(err || err.message);
					}
				})();

			</script>
			<footer>
				<p>BladeCAPTCHA · Documentación técnica · MIT License</p>
			</footer>
		</main>
		<script>
			const menuToggle = document.querySelector('.menu-toggle');
			const navLinks = document.querySelector('.nav-links');
			menuToggle.addEventListener('click', () => {
				const isOpen = navLinks.classList.toggle('show');
				menuToggle.innerHTML = isOpen ? `
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
				  <line x1="18" y1="6" x2="6" y2="18"/>
				  <line x1="6" y1="6" x2="18" y2="18"/>
				</svg>` : '<span class="emoji">☰</span>';
				menuToggle.setAttribute('aria-label', isOpen ? 'Cerrar menú' : 'Abrir menú');
			});

		</script>
	</body>
</html>
