async function initCaptcha(e){const o=(e={mode:"manualHandling",onSuccess:null,onError:null,formSelector:"",inputName:"captcha_token",statusSelector:"",verifyButtonSelector:"",submitButtonSelector:"",onLoading:null,cancelLoading:null,onProgress:null,manualHandlingAutoStartOnLoad:!1,...e}).verifyButtonSelector?document.querySelector(e.verifyButtonSelector):null,n=e.statusSelector?document.querySelector(e.statusSelector):null;let r=e.inputName?document.querySelector(`[name="${e.inputName}"]`):null;const t=e.formSelector?document.querySelector(e.formSelector):null,a=e.submitButtonSelector?document.querySelector(e.submitButtonSelector):null;let s=!1,c={success:!1,error:!1};function i(e,o=""){n&&(n.textContent=e,n.className=o)}function l(e){if(e instanceof Error&&e.message)return e.message;if("string"==typeof e)return e;try{return JSON.stringify(e)}catch{return String(e)}}function u(o,...n){if("onSuccess"===o){if(c.success)return;if(c.success=!0,"function"==typeof e.onSuccess)try{e.onSuccess(...n)}catch(e){console.error("onSuccess error",e)}}else if("onError"===o){if(c.error)return;if(c.error=!0,"function"==typeof e.onError)try{e.onError(...n)}catch(e){console.error("onError error",e)}}}async function d(e,o={}){try{const n=await fetch(e,o);if(!n.ok){let e;try{e=await n.json()}catch(o){e={message:await n.text().catch(()=>"")||`HTTP ${n.status}`}}throw new Error(e.message||`HTTP ${n.status}`)}return(n.headers.get("content-type")||"").includes("application/json")?await n.json():await n.text()}catch(e){throw e}}async function f(){if(i("Obteniendo desafío...","loading"),s)return{success:!1,message:"Otro proceso en curso"};s=!0,c={success:!1,error:!1},o&&(o.disabled=!0);try{const{challenge:o,difficulty:a}=await d("../php/captcha.php",{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({proceso:"GET_POW_CHALLENGE"})});let s;i("Resolviendo desafío...","loading");try{s=await function(o,r){return new Promise((t,a)=>{const s=new Worker("../js/workers/pow-worker.min.js"),c="function"==typeof e.onProgress,l=!!n;try{s.postMessage({challenge:o,difficulty:r,loguear:l,progress:c})}catch(e){return s.terminate(),a(e)}let u=!1;s.onmessage=o=>{const n=o.data||{};n.error?u||(u=!0,"function"==typeof e.onProgress&&e.onProgress(100),a(new Error(n.error)),s.terminate()):n.log?i(n.log):void 0===n.perc?void 0!==n.nonce&&(u||(u=!0,"function"==typeof e.onProgress&&e.onProgress(100),t(n.nonce),s.terminate())):"function"==typeof e.onProgress&&e.onProgress(Number(n.perc))},s.onerror=o=>{u||(u=!0,"function"==typeof e.onProgress&&e.onProgress(100),a(new Error("Error en worker: "+(o?.message||o))),s.terminate())}})}(o,a)}catch(e){const o=`Error: ${l(e)}`;return i(o,"error"),u("onError",e),{success:!1,message:o}}i("Enviando resultado...","loading");const c="VALIDATE_POW_CHALLENGE",f=await d("../php/captcha.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:o,nonce:s,proceso:c})});if(i(f.message||"",f.success?"success":"error"),f.success&&t&&(r||(r=document.createElement("input"),r.name=e.inputName,r.type="hidden",t.appendChild(r)),r.value=f.token_validacion||""),f.success)return u("onSuccess",f.token_validacion||""),{success:!0,token:f.token_validacion||"",message:f.message||""};return u("onError",new Error(f.message||"Validación fallida")),{success:!1,message:f.message||"Validación fallida"}}catch(e){const o=`Error: ${l(e)}`;return i(o,"error"),u("onError",e),{success:!1,message:o}}finally{o&&(o.disabled=!1),s=!1}}async function g(){const{token:e,target_iterations:o}=await d("../php/captcha.php",{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({proceso:"getPerformanceChallenge"})});try{await function(e=1e6){return new Promise((o,n)=>{const r=new Worker("../js/workers/benchmark-worker.min.js");r.postMessage({iterations:e}),r.onmessage=e=>{e.data&&e.data.done?o():n(new Error("Benchmark no finalizó correctamente")),r.terminate()},r.onerror=e=>{n(e),r.terminate()}})}(o)}catch(e){console.log("Benchmark falló",e)}await d("../php/captcha.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,proceso:"verifyPerformanceChallenge"})})}async function m(){if(!s){if("function"==typeof e.onLoading)try{e.onLoading()}catch(e){console.error(e)}if("function"==typeof e.onProgress)try{e.onProgress(0)}catch(e){console.error(e)}if(await g(),await f(),"function"==typeof e.cancelLoading)try{e.cancelLoading()}catch(e){console.error(e)}if("function"==typeof e.onProgress)try{e.onProgress(0)}catch(e){console.error(e)}}}if("manualHandling"===e.mode)o||e.manualHandlingAutoStartOnLoad||console.warn('⚠️ No se encontró "verifyButtonSelector" y "manualHandlingAutoStartOnLoad" está desactivado.\n   La verificación no podrá iniciarse de forma manual ni automática.'),o&&e.manualHandlingAutoStartOnLoad&&console.info('ℹ️ "manualHandlingAutoStartOnLoad" está activado y también existe un botón de verificación.\n   Esto puede ser redundante: la verificación se ejecutará automáticamente al cargar la página, pero el botón seguirá visible para volver a ejecutarla si se desea.'),document.addEventListener("DOMContentLoaded",async()=>{o&&o.addEventListener("click",m),e.manualHandlingAutoStartOnLoad&&await m()});else if("autoFormIntegration"===e.mode){if(!a)return void console.warn("No se encontró submitButtonSelector");if(!t)return void console.warn("No se encontró formSelector");document.addEventListener("DOMContentLoaded",()=>{a.addEventListener("click",async o=>{if(o.preventDefault(),!a.disabled&&!s){if(a.disabled=!0,"function"==typeof e.onLoading)try{e.onLoading()}catch(o){console.error(o)}"function"==typeof e.onProgress&&e.onProgress(0),await g();try{const e=await f(),o=e.token||(r?r.value:""),n=!!o&&/^[a-f0-9]{32}$/i.test(o);if(e.success&&n)return void t.submit();const a=e.message||"No se pudo completar la verificación.";i(a,"error"),u("onError",new Error(a))}catch(e){i(`Error: ${l(e)}`,"error"),u("onError",e)}finally{if(s=!1,a.disabled=!1,"function"==typeof e.cancelLoading)try{e.cancelLoading()}catch(o){console.error(o)}if("function"==typeof e.onProgress)try{e.onProgress(0)}catch(o){console.error(o)}}}})})}}